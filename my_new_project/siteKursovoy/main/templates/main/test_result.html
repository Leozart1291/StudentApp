{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{
      background:#fff;
      font-family:'Poppins', sans-serif;
      margin:0;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      padding-top:50px;
    }

    .result-container{
      max-width:600px;
      margin:80px auto 30px;
      background:#fff;
      border-radius:20px;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
      text-align:center;
      padding:40px;
    }

    h2{ color:#0255A5; font-weight:700; margin-bottom:25px; }
    .score{ font-size:2rem; font-weight:600; color:#333; margin-bottom:18px; }
    .passed{ color:#0255A5; font-weight:600; font-size:1.1rem; margin-bottom:18px; }
    .failed{ color:#ff4d4d; font-weight:600; font-size:1.1rem; margin-bottom:18px; }

    .btn-main{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 22px;
      border-radius:10px;
      font-weight:600;
      font-size:1rem;
      transition:.2s ease;
      border:none;
      color:#fff;
      background:#0255A5;
      text-decoration:none;
    }
    .btn-main:hover{ background:#023e7d; transform:scale(1.02); }
    .btn-secondary-soft{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      padding:12px 22px;
      border-radius:10px;
      font-weight:600;
      font-size:1rem;
      transition:.2s ease;
      border:1px solid #dbe7f5;
      color:#0255A5;
      background:#f7fbff;
      text-decoration:none;
    }
    .btn-secondary-soft:hover{ background:#eef7ff; transform:scale(1.02); }

    footer{
      text-align:center;
      color:#0255A5;
      margin-top:auto;
      padding:20px 0;
      font-size:.95rem;
    }

    /* ===== AI ANALYSIS (–∫–∞–∫ –Ω–∞ —Ñ–æ—Ç–æ 3) ===== */
    .ai-wrap{
      max-width:1100px;
      margin:0 auto 70px;
      padding:0 20px;
    }

    .ai-card{
      background:#fff;
      border:1px solid #eef0f3;
      border-radius:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.05);
      padding:22px;
    }

    .ai-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:1.35rem;
      font-weight:800;
      margin:0 0 10px;
    }
    .ai-icon{
      width:34px; height:34px;
      border-radius:10px;
      display:grid; place-items:center;
      background:#f0f6ff;
      color:#0255A5;
      font-weight:900;
    }

    .ai-sub{
      color:#6b7280;
      margin:0 0 12px;
    }

    .ai-pill{
      display:inline-flex;
      align-items:center;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid #e6eef9;
      background:#f7fbff;
      font-weight:700;
      color:#111827;
      margin:10px 0 14px;
    }

    .ai-divider{
      height:1px;
      background:#edf0f3;
      margin:16px 0;
    }

    .ai-section-title{
      font-size:1.15rem;
      font-weight:800;
      margin:0 0 10px;
    }

    .ai-verdict{
      display:flex;
      align-items:flex-start;
      gap:10px;
      font-size:1rem;
      margin:4px 0 0;
    }
    .ai-verdict .mark{
      width:22px; height:22px;
      border-radius:6px;
      display:grid; place-items:center;
      font-weight:900;
      line-height:1;
      margin-top:1px;
    }
    .mark.bad{ background:#ffecec; color:#e11d48; }
    .mark.good{ background:#ecfdf3; color:#16a34a; }

    .ai-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 780px){
      .ai-grid{ grid-template-columns:1fr; }
    }

    .mini-card{
      border:1px solid #eef0f3;
      border-radius:12px;
      padding:14px;
      background:#fff;
    }
    .mini-head{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      margin-bottom:10px;
    }
    .mini-badge{
      width:22px; height:22px;
      border-radius:6px;
      display:grid; place-items:center;
      font-size:.9rem;
      font-weight:900;
    }
    .mini-badge.ok{ background:#ecfdf3; color:#16a34a; }
    .mini-badge.warn{ background:#fff7ed; color:#f97316; }

    .ai-list{ margin:0; padding-left:18px; color:#111827; }
    .ai-list li{ margin:6px 0; }

    .rec-card{
      margin-top:14px;
      border:1px solid #eef0f3;
      border-radius:12px;
      padding:14px;
      background:#fff;
    }
    .rec-head{
      display:flex; align-items:center; gap:10px;
      font-weight:900; margin-bottom:10px;
    }
    .rec-ico{
      width:22px; height:22px;
      border-radius:6px;
      display:grid; place-items:center;
      background:#eff6ff; color:#2563eb;
      font-weight:900;
    }

    /* show/hide */
    .hidden{ display:none !important; }
  </style>
</head>

<body>

{% include "partials/navbar.html" %}

<!-- ====== –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–∫–∞–∫ —Ñ–æ—Ç–æ 2) ====== -->
<div class="result-container">
  <h2>–¢–µ—Å—Ç –Ω”ô—Ç–∏–∂–µ—Å—ñ</h2>

  <div class="score">{{ score|floatformat:0 }}%</div>

  {% if passed %}
    <div class="passed">‚úÖ –¢–µ—Å—Ç —Ç–∞–ø—Å—ã—Ä—ã–ª–¥—ã!</div>
  {% else %}
    <div class="failed">‚ùå –¢–µ—Å—Ç —Ç–∞–ø—Å—ã—Ä—ã–ª–º–∞–¥—ã. “ö–∞–π—Ç–∞ —Ç—ã—Ä—ã—Å—ã–ø –∫”©—Ä—ñ“£—ñ–∑!</div>
  {% endif %}

  <!-- –ö–Ω–æ–ø–∫–∏ -->
  <div class="d-flex flex-wrap gap-2 justify-content-center mt-3">
    <button id="aiAnalyzeBtn" class="btn-secondary-soft" type="button">
      ü§ñ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –ò–ò
    </button>

    <a href="{% url 'course_learn' lesson.module.course.id %}" class="btn-main">
      –ú–æ–¥—É–ª—å–¥–µ—Ä–≥–µ “õ–∞–π—Ç—É
    </a>
  </div>

  <!-- –õ–æ–∞–¥–µ—Ä (–ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞) -->
  <div id="aiLoading" class="hidden mt-4">
    <div class="d-flex align-items-center justify-content-center gap-2">
      <div class="spinner-border text-primary" role="status" aria-hidden="true" style="width:1.4rem;height:1.4rem;"></div>
      <div style="font-weight:700;color:#0255A5;">–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç—ã...</div>
    </div>
    <div class="mt-2" style="color:#6b7280;font-size:.95rem;">–≠—Ç–æ –∑–∞–π–º–µ—Ç –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥</div>
  </div>
</div>

<!-- ====== –ë–ª–æ–∫ "–ê–Ω–∞–ª–∏–∑ –ò–ò" (–∫–∞–∫ —Ñ–æ—Ç–æ 3) ====== -->
<div class="ai-wrap">
  <div id="aiBlock" class="ai-card hidden">

    <div class="ai-title">
      <div class="ai-icon">ü§ñ</div>
      <div>–ê–Ω–∞–ª–∏–∑ –ò–ò</div>
    </div>

    <p class="ai-sub" id="aiLessonLine">
      –£—Ä–æ–∫: <b>{{ lesson.title }}</b>
    </p>

    <div class="ai-pill" id="aiScorePill">
      –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞: <span class="ms-1" id="aiScoreText">{{ score|floatformat:0 }}%</span>
    </div>

    <div class="ai-divider"></div>

    <div class="ai-section-title">–í—ã–≤–æ–¥</div>
    <div class="ai-verdict">
      <div class="mark bad" id="aiVerdictMark">‚úñ</div>
      <div id="aiVerdictText">‚Äî</div>
    </div>

    <div class="ai-grid">
      <div class="mini-card">
        <div class="mini-head">
          <div class="mini-badge ok">‚úì</div>
          <div>–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã</div>
        </div>
        <ul class="ai-list" id="aiStrengthsList"></ul>
      </div>

      <div class="mini-card">
        <div class="mini-head">
          <div class="mini-badge warn">!</div>
          <div>–°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã</div>
        </div>
        <ul class="ai-list" id="aiWeaknessesList"></ul>
      </div>
    </div>

    <div class="rec-card">
      <div class="rec-head">
        <div class="rec-ico">‚ûú</div>
        <div>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>
      </div>
      <ul class="ai-list" id="aiRecsList"></ul>
    </div>

  </div>
</div>

<footer>
  ¬© {{ year|default:2025 }} StudentApp ‚Äî —É—á–∏—Å—å, —Ä–∞–∑–≤–∏–≤–∞–π—Å—è –∏ –¥–æ—Å—Ç–∏–≥–∞–π —Ü–µ–ª–∏
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /**
   * ‚úÖ –¢–£–¢ –ú–ï–ù–Ø–ï–®–¨ –¢–ï–ö–°–¢–´ –û–ß–ï–ù–¨ –õ–ï–ì–ö–û
   * –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞: passed / failed
   * (–∏–ª–∏ –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å —Å backend ‚Äî –Ω–∏–∂–µ –ø–æ–∫–∞–∂—É –∫–∞–∫)
   */
  const AI_TEXT = {
    passed: {
      verdict: "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–º–∞ —É—Å–≤–æ–µ–Ω–∞ –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ.",
      mark: "good", // good | bad
      strengths: [
        "–¢—ã —Ö–æ—Ä–æ—à–æ –ø–æ–Ω—è–ª –∫–ª—é—á–µ–≤—ã–µ –ø–æ–Ω—è—Ç–∏—è",
        "–ü–æ—á—Ç–∏ –±–µ–∑ –æ—à–∏–±–æ–∫"
      ],
      weaknesses: [
        "‚Äî"
      ],
      recs: [
        "–ú–æ–∂–µ—à—å –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–∫—É"
      ]
    },
    failed: {
      verdict: "–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–ª–∞–±—ã–π ‚Äî –Ω—É–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ–º—É.",
      mark: "bad",
      strengths: [
        "‚Äî"
      ],
      weaknesses: [
        "–ú–Ω–æ–≥–æ –æ—à–∏–±–æ–∫"
      ],
      recs: [
        "–ü–æ–≤—Ç–æ—Ä–∏ —É—Ä–æ–∫, —Å–¥–µ–ª–∞–π –∫–æ–Ω—Å–ø–µ–∫—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞"
      ]
    }
  };

  // ‚úÖ –∑–∞–¥–µ—Ä–∂–∫–∞ (–º—Å) –∏–º–∏—Ç–∞—Ü–∏–∏ –∞–Ω–∞–ª–∏–∑–∞
  const AI_DELAY_MS = 2500;

  // passed –∏–∑ Django:
  const PASSED = {{ passed|yesno:"true,false" }};
  const SCORE  = Number("{{ score|floatformat:0 }}");

  const btn = document.getElementById("aiAnalyzeBtn");
  const loading = document.getElementById("aiLoading");
  const aiBlock = document.getElementById("aiBlock");

  const verdictText = document.getElementById("aiVerdictText");
  const verdictMark = document.getElementById("aiVerdictMark");

  const strengthsList = document.getElementById("aiStrengthsList");
  const weaknessesList = document.getElementById("aiWeaknessesList");
  const recsList = document.getElementById("aiRecsList");

  function fillList(ul, items){
    ul.innerHTML = "";
    (items && items.length ? items : ["‚Äî"]).forEach(t => {
      const li = document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });
  }

  function renderAI(){
    const data = PASSED ? AI_TEXT.passed : AI_TEXT.failed;

    // verdict
    verdictText.textContent = data.verdict;

    // mark color
    const isGood = data.mark === "good";
    verdictMark.classList.toggle("good", isGood);
    verdictMark.classList.toggle("bad", !isGood);
    verdictMark.textContent = isGood ? "‚úì" : "‚úñ";

    // lists
    fillList(strengthsList, data.strengths);
    fillList(weaknessesList, data.weaknesses);
    fillList(recsList, data.recs);
  }

  btn.addEventListener("click", () => {
    btn.disabled = true;
    loading.classList.remove("hidden");

    setTimeout(() => {
      loading.classList.add("hidden");
      renderAI();
      aiBlock.classList.remove("hidden");

      // –∫—Ä–∞—Å–∏–≤–æ –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏–º –∫ –∞–Ω–∞–ª–∏–∑—É
      aiBlock.scrollIntoView({ behavior: "smooth", block: "start" });
    }, AI_DELAY_MS);
  });
</script>
</body>
</html>